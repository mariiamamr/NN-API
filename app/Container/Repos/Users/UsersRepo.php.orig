<?php

/**
 * Created by PhpStorm.
 * User: Backend Dev
 * Date: 5/17/2018
 * Time: 11:31 AM
 */

namespace Repos\Users;


use App\User;
use App\Admin;
use App\File;
use App\Certificate;
use Contracts\Users\UsersContract;
use Contracts\UserInfos\UserInfosContract;
use Contracts\Files\FilesContract;
use App\Grade;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\DB;
use Contracts\Roles\RolesContract;
use App\Permission;
use App\Notifications\Admin\AdminNotification;
use Illuminate\Notifications\Notifiable;
use Illuminate\Support\Facades\Notification;

class UsersRepo implements UsersContract
{
    public $number_of_pages = 1;

    protected $addCertificationValidationRules  = [
        'certifications.*.thumb' => 'mimes:jpeg,jpg,png,pdf,svg',
    ];

    protected $addCertificationValidationMessages = [
        'certifications.*.thumb.mimes' => 'The Certifications File must be a file of type: jpeg, jpg, png, pdf, svg.',
    ];
    

    public function __construct(
        User $user,
        UserInfosContract $user_info,
        FilesContract $file,
        Admin $admin,
        Permission $permission, 
        RolesContract $role
    ) {
        $this->user = $user;
        $this->user_info = $user_info;
        $this->file = $file;
        $this->number_of_pages = config('static.pagination.rowsPerPage');
        $this->admin = $admin;
        $this->permission = $permission;
        $this->role = $role;
    }

    public function get($id)
    {
        return $this->user->with('profile', 'specialist_in', 'languages', 'edu_systems', 'latestReviews')->find($id);
    }

    public function getAll($type = '')
    {
        return $this->user->where('type', 'like', '%' . $type . '%')->all();
    }

    public function set($data, $social = false)
    {
        $row = [
            'username' => $data->username,
            'email' => $data->email,
            "gender" => (isset($data->gender)) ? $data->gender : "male",
            "type" => (isset($data->type)) ? $data->type : "s",
        ];

        $user = $this->user->create($row);
        
        return $user;
    }

    public function update($id, $data)
    {
        return $this->get($id)->update([
            'username' => $data->username,
            'email' => $data->email,
            "gender" => (isset($data->gender)) ? $data->gender : "male",
            "type" => (isset($data->type)) ? $data->type : "s",
        ]);
    }

    public function delete($id)
    {
        return $this->get($id)->delete();
    }

    public function getByEmail($email)
    {
        return $this->user->where('email', $email)->first();
    }

    public function login($data)
    {
        if (isset($data->provider)) {
            $user = $this->findOrCreateSocialUserAPI($data);
            if (gettype($user) == 'intege') {
                return $user;
            }
        } else {
            $user = $this->getByEmail($data->email);

            if (is_null($user)) {
                return config('api.response_code.wrong_credentials');
            }

            //check if current password are the same

            if (!password_verify($data->password, $user->password)) {
                return config("api.response_code.wrong_credentials");
            }
        }
        // all good so return the token
        return $user;
    }

    public function register($data)
    {
        if (isset($data->provider)) {
            $user = $this->findOrCreateSocialUserAPI($data);
            if (gettype($user) == ' integer') {
                return $user;
            }
        } else {
            $user = $this->set($data);
        }
        return $user;
    }

    public function changeUserStatus($id, $status)
    {
        return $this->get($id)->update([
            "status" => (boolean)$status
        ]);
    }

    public function paginate($type = ' ', $search = ' ')
    {
        return $this->user->where('type', 'like', '%' . $type . '%')->where(function ($query) use ($search) {
            return $query->where('username', 'like', '%' . $search . '%')
                ->orWhere('full_name', 'like', '%' . $search . '%');
        })->paginate($this->number_of_pages);
    }

    public function mostRatedTeachersMonthly($limit = 3)
    {
        /*  return collect($this->user_info->mostRatedTeachersMonthly($limit))->transform(function ($profile) {
            return $profile->users;
        }); */

        return $this->user->where('type', 't')
            ->where('status', true)
            ->whereHas('profile', function ($query) use ($limit) {
                return $query
                    ->where('month_rate', ">", 0)
                    ->orderBy('month_rate', 'DESC')
                    ->take($limit);
            })->get();
    }

    public function updateStudentProfile($id, $data)
    {
        \tap($user = $this->get($id))->update([
            'full_name' => $data->full_name,
            'birth' => $data->birth,
            "gender" => (isset($data->gender)) ? $data->gender : "male",
        ]);
        $user->grades()->sync($data->grade);
        return $user;
    }

    public function addSubUsers($id, $data)
    {
        return $this->get($id)->subusers()->create([
            "first_name" => $data->first_name,
            "last_name" => $data->last_name,
            "name" => $data->name,
            "password" => Hash::make($data->password)
        ]);
    }

    public function approvedTeachersPaginate($search = '')
    {
        return $this->user->where('status', 1)
            ->where('type', 't')
            ->where(function ($query) use ($search) {
                return $query->where('username', 'like', '%' . $search . '%')
                    ->orWhere('full_name', 'like', '%' . $search . '%');
            })
            ->with('profile', 'specialist_in')
            ->paginate($this->number_of_pages);
    }

    public function uploadImageProfile($id, $data)
    {
        $user = $this->get($id);
        if(isset($data->image)){
            $image = $data->image;
            if ($image->isValid()) {
                $user->image_url = $this->file->uploadTeacherProfile($image);
            }
            $user->save();
            return $user;
        }
    }

    public function searchForTeachers($data, $limit = null)
    {
        $query = $this->user
            ->where('status', 1)
            ->where('active', 1)
            ->where('type', 't');

        if (isset($data->available)) {
            $query = $query->where(function ($query) {
                $query->whereHas('profile', function ($q) {
                    return $q->whereNotNull('weekly');
                })
                    ->orWhereHas('lectures', function ($q) {
                        return $q->where('started', false)
                            ->whereNull('checkout_user_id')
                            ->whereNull('payed_user_id')
                            ->where('date', '>=', date('Y-m-d'));
                    });
            });
        }

        if (isset($data->lang) && !empty($data->lang)) {
            $query = $query->whereHas('languages', function ($query) use ($data) {
                return $query->where("languages.id", $data->lang);
            });
        }

        if (isset($data->subject) && !empty($data->subject)) {
            $query = $query->whereHas('specialist_in', function ($query) use ($data) {
                return $query->where('subjects.id', $data->subject);
            });
        }

        if (isset($data->grade) && !empty($data->grade)) {
            $query = $query->whereHas('grades', function ($query) use ($data) {
                return $query->where("grades.id", $data->grade);
            });
        }

        // if (isset($data->rate) && !empty($data->rate)) {
        $query = $query->whereHas('profile', function ($q) use ($data) {
            $q = $q->orderBy('month_rate', 'DESC');
            if (isset($data->rate) && !empty($data->rate)) {
                $q = $q->where('month_rate', ">=", $data->rate);
            }
            return $q;
        });
        // }

        if (isset($data->price) && !empty($data->price)) {
            $query = $query->whereHas('profile', function ($q) use ($data) {
                $q = $q->orderBy(DB::raw('JSON_VALUE(`price_info`," $.individual")'), 'DESC')
                    ->where(function ($q) use ($data) {
                        return $q->whereRaw('JSON_VALUE(`price_info`," $.individual") = ' . $data->price)->orWhereRaw('JSON_VALUE(`price_info`," $.group") = ' . $data->price);
                    });
                return $q;
            });

        }        
        return (is_null($limit)) ? $query->paginate($this->number_of_pages) : $query->limit($limit)->get();
    }

    public function updateTeacherProfile($id, $data)
    {
        $user = $this->get($id);
        if (isset($data->full_name)) {
            \tap($user->update([
                'full_name' => $data->full_name,
                'birth' => $data->date,
                "gender" => (isset($data->gender)) ? $data->gender : "male",
            ]));
        }

        if(isset($data->image)){
            $image = $data->image;
                $user->image_url = $this->file->uploadTeacherProfile($image);
            $user->save();
        }

        if (isset($data->subjects)) {
            $subjects = array_values(array_filter($data->subjects, function ($item) {
                return  preg_replace('/[^\d]/', '', $item);
            }));
            $data['suggested_subjects'] = array_values(array_filter($data->subjects, function ($item) {
                return !preg_replace('/[^\d]/', '', $item) && !is_null($item);
            }));

            $user->specialist_in()->sync(array_filter($subjects));
        }
        
        if (isset($data->languages)) {
            $user->languages()->sync(array_filter($data->languages));
        }

        if (isset($data->grades)) {
            $user->grades()->sync(array_filter($data->grades));
        }


        if (isset($data->edu_systems)) {
            $user->edu_systems()->sync(array_filter($data->edu_systems));
        }

        if(isset($data->certifications)){

            //Validation for uploading file extenstions
            $data->validate($this->addCertificationValidationRules, $this->addCertificationValidationMessages); 

            // Array for save the ids of files in uploading
            $certificates_array=[];
            foreach($data->certifications as $key => $certificate){
                if(isset($certificate['thumb'])){
                    $file = $certificate['thumb'];
                    if ($file->isValid()) {
                        $fileName = $this->file->uploadCertificate($file);
                        $certificates_array[$key] = [
                            'certificate_id' => $certificate['certificate_id'],
                            'thumb_name' => $fileName
                        ];
                    }
                }
                else {
                    $certificates_array[$key] = [
                        'certificate_id' => $certificate['certificate_id'] ? $certificate['certificate_id'] : null ,
                        'thumb_name' => $certificate['thumb_name'] ? $certificate['thumb_name'] : null
                    ];
                }
            }
            $data->certifications = json_encode($certificates_array);
            $user->profile->update([
                'certifications' => "$data->certifications"
            ]);
        }

        if(isset($data->price_info)){
            $permission = $this->permission->where('name', 'teacher-price_approval')->first();
            $roles = $permission->roles()->get()->pluck('id')->toArray();
            $admins = $this->admin->whereIn('role_id', $roles)->get();
            $message = 'Price approval of teacher needing for approval!';
            Notification::send($admins, new AdminNotification($message));
        }

        $user->profile = $this->user_info->updateByUserID($user->id, $data, $user->status);

        return $user;
    }

    public function getWith($id, $array)
    {
        return $this->user->with($array)->find($id);
    }

    public function teacherWithProfile($search = ' ')
    {
        return $this->user->where('type', 't')->where(function ($query) use ($search) {
            return $query->where('username', 'like', '%' . $search . '%')
                ->orWhere('full_name', 'like', '%' . $search . '%');
        })->whereHas('profile')->paginate($this->number_of_pages);
    }

    public function paidSessions($user)
    {
        return $user->registeredSessions()->where('payed',true)->get();
    }
}
